pipeline {
    agent any

    environment {
        KUBECTL = '/usr/local/bin/kubectl'
        HELM    = '/usr/local/bin/helm'
        PATH    = "/usr/local/bin:/usr/bin:/bin"
        AWS_REGION = "us-east-1"
    }

    parameters {
        string(
            name: 'CLUSTER_NAME',
            defaultValue: 'amazon-prime-cluster',
            description: 'Enter your EKS cluster name'
        )
    }

    stages {

        /* ============================= */
        stage("Login to EKS") {
            steps {
                withCredentials([
                    string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY'),
                    string(credentialsId: 'secret-key', variable: 'AWS_SECRET_KEY')
                ]) {
                    sh """
                    export AWS_ACCESS_KEY_ID=\$AWS_ACCESS_KEY
                    export AWS_SECRET_ACCESS_KEY=\$AWS_SECRET_KEY
                    export AWS_REGION=${AWS_REGION}

                    aws eks update-kubeconfig \
                    --region ${AWS_REGION} \
                    --name ${params.CLUSTER_NAME}

                    ${KUBECTL} get nodes
                    """
                }
            }
        }

        /* ============================= */
      stage("Configure Prometheus & Grafana") {
    steps {
        sh """
        /usr/local/bin/helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
        /usr/local/bin/helm repo update

        # Create namespace if missing
        /usr/local/bin/kubectl create namespace prometheus || true

        # Install OR Upgrade (SAFE)
        /usr/local/bin/helm upgrade --install kube-prometheus-stack \
        prometheus-community/kube-prometheus-stack \
        -n prometheus

        # Expose services
        /usr/local/bin/kubectl patch svc kube-prometheus-stack-prometheus \
        -n prometheus -p '{"spec":{"type":"LoadBalancer"}}' || true

        /usr/local/bin/kubectl patch svc kube-prometheus-stack-grafana \
        -n prometheus -p '{"spec":{"type":"LoadBalancer"}}' || true
        """
    }
}


        /* ============================= */
        stage("Configure ArgoCD") {
    steps {
        sh """
        # Add ArgoCD repo
        /usr/local/bin/helm repo add argo https://argoproj.github.io/argo-helm || true
        /usr/local/bin/helm repo update

        # Create namespace
        /usr/local/bin/kubectl create namespace argocd || true

        # Install ArgoCD via Helm (SAFE)
        /usr/local/bin/helm upgrade --install argocd argo/argo-cd \
        -n argocd

        # Expose ArgoCD UI
        /usr/local/bin/kubectl patch svc argocd-server \
        -n argocd -p '{"spec":{"type":"LoadBalancer"}}'
        """
    }
}

        /* ============================= */
        stage("Check Services") {
            steps {
                sh """
                ${KUBECTL} get svc -A
                """
            }
        }
    }

    post {
        success {
            echo "Monitoring + ArgoCD configured successfully üöÄ"
        }
        failure {
            echo "Pipeline failed ‚ùå"
        }
    }
}
